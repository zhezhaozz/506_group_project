---
title: "additional analysis"
output: html_document
---

```{r setup, include=FALSE}
# Stats 506 group project
# script for additional analysis 
# data.table, lm
#
# Author: Zhe Zhao
# Last updated: Dec 10th

knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(magrittr)
library(splines)
library(car)
library(effects)

# read the data
dt = fread("cleaned_data.csv")
```

After examing the mutiple linear regression in the core analysis, I'm interested in
a more complicated model considering intercations and transformations to adjust the 
non-linearity and non-constant variance.

The following model considers the logarithm of average systolic blood pressure. For
variables alchol and sleep, the model apply them into basis splines function with
degrees of freedom 5 and order of three, with 2 knots. Interaction effect between 
worhrs and all other variables are considered. The estimations and significance level
are reported in the following:
```{r}
fit_sys = lm( log(avg_sys_bp) ~ workhrs * (age + gender + bmi + bs(alchol, 5) + 
                                             bs(sleep, 5) + smoke) + smoke:alchol,
              data = dt)

summary(fit_sys)
AIC(fit_sys)
```
The model has R-squared 0.2317. The F-test against the null model calcutes the statistic 
of 2.081 with 30 and 207 degrees of freedom. The p-value is 0.00154, which suggests
the statistical significance of this model in 0.05 confidence level. The AIC of this
model is -252.428.

```{r}
vif(fit_sys)
```
When checking the variance inflation factor, I find that workhrs, workhrs:age, and
workhrs:bmi are greatly inflated (more than 5). It suggests that there might be 
significant effect of collinearity, which may unstable the coefficients estimations.

```{r}
par( mfrow = c(2,2) )
plot(Effect("age", fit_sys, partial.residuals = TRUE))
plot(Effect("bmi", fit_sys, partial.residuals = TRUE))
plot(Effect("alchol", fit_sys, partial.residuals = TRUE))
plot(Effect("sleep", fit_sys, partial.residuals = TRUE))
```
Above plots examine the effect of each continuous variables in the model on the 
response variable. The blue lines shows the relationship from the model. The red dots
are partial residuals and the red line shows how each variable correlates to the 
response variable after controlling all other variables. We see that our model dose
quite well on explaining the correlation for age, bmi and alchol. The basis spline 
function of Sleep, as we can see, become very unstable at the boundary points. This 
might suggests extrapolation bias.

The coefficients of this model is very hard to interpret, even though the model 
roughly satisfies the linear modeling assumptions. However, the model is still useful 
to explain several research questions. In the following example, I examine if sleep 
for 5 hours would cause significant difference on blood pressure than sleep for 8 hours
if they both work overtimes.

To answer the question, if we directly use the model, we need to consider interaction
terms on variables interested, and coefficients of basis splines transformation 
on sleep are more meaningful in mathematic rather than practical setting. 

The code below create two fake datasets accroding to the original dataset. One with
all sleep equals to 8 while the other equal to 5. Both dataset has workhrs as 1.
After combining the original dataset with two fake datasets, we assign weights 1 to
all original observations and zero to all fake observations. The purpose of assigning 
weights is to get the same coefficients with the previously fitted model and the 
same structure of the design matrix (same interactions and transformation, but with
fake data). Above steps help us to get the contrast value by applying the model 
coefficients to our data generated by test assumptions.
```{r}
# would difference between work overtimes but sleep for 8 hours and work overtimes 
# while sleep for 5 hours less significant?
dt = dt[, wgt := 1]
d_fake_8hrs = dt[, `:=` (workhrs = 1, sleep = 8, wgt = 0)] # make fake data with contrast
d_fake_5hrs = dt[, `:=` (workhrs = 1, sleep = 5, wgt = 0)] # make fake data with contrast

dx = rbindlist( list(dt, d_fake_8hrs, d_fake_5hrs) ) # combine tru data with fake data

result = lm( log(avg_sys_bp) ~ workhrs * (age + gender + bmi + bs(alchol, 5) + 
                                             bs(sleep, 5) + smoke) + smoke:alchol,
             weights = wgt, data = dx) # fit regression with zero weights on fake data

pa = coef(result) # parameters
cm = vcov(result) # covariance matrix
dm = model.matrix(result) # design matrix
nx = 238

ct = dm[ (nx+1):(nx+2*nx), ]
ct = ct[1:nx,] - ct[(nx+1):(2*nx), ] # get the contrast

znum = ct %*% pa # numerator of z-score
zdenom = sqrt(diag(ct %*% cm %*% t(ct))) # denominator of z-score
zscores = znum / zdenom

z_criticle = qnorm(0.975)

{mean(zscores) > z_criticle}
```
The z-score is 0.864, which is lesser than 1.96. We failed to reject the null hypothesis 
that sleep 5 hours would cause difference in blood pressur than sleep 8 hours if 
both people work overtimes.

